---
title: Mensagens, payloads e serialização do Barramento de Serviço do Azure | Microsoft Docs
description: Este artigo fornece uma visão geral das mensagens, cargas, roteamento de mensagens e serialização do barramento de serviço do Azure.
ms.topic: article
ms.date: 01/29/2021
ms.openlocfilehash: e1baca1cd3dedee5917670a00b62c68752b5e4b8
ms.sourcegitcommit: 97c48e630ec22edc12a0f8e4e592d1676323d7b0
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 02/18/2021
ms.locfileid: "101095099"
---
# <a name="messages-payloads-and-serialization"></a>Mensagens, payloads e serialização

O Barramento de Serviço do Microsoft Azure lida com mensagens. As mensagens carregam uma carga e metadados. Os metadados estão na forma de propriedades de pares chave-valor e descrevem a carga e fornecem instruções de manipulação para o barramento de serviço e os aplicativos. Ocasionalmente, esses metadados sozinhos são suficientes para carregar as informações que o remetente deseja comunicar aos destinatários e o payload permanece vazio.

O modelo de objeto dos clientes oficiais do Barramento de Serviço para .NET e Java reflete a estrutura de mensagem do Barramento de Serviço abstrato, que é mapeada para e dos protocolos de transmissão compatíveis com o Barramento de Serviço.
 
Uma mensagem do Barramento de Serviço consiste em uma seção de payload binário que o Barramento de Serviço nunca manipula em nenhuma forma no lado do serviço e dois conjuntos de propriedade. As *propriedades do agente* são predefinidas pelo sistema. Essas propriedades predefinidas controlam a funcionalidade de nível de mensagem dentro do agente ou são mapeados para os itens de metadados comuns e padronizados. As *propriedades do usuário* são uma coleção de pares chave-valor que podem ser definidas pelo aplicativo.
 
As propriedades do agente predefinidas são listadas na tabela a seguir. Os nomes são usados com todas as APIs oficiais do cliente e também no objeto JSON [BrokerProperties](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage) do mapeamento do protocolo HTTP.
 
Os nomes equivalentes usados no nível do protocolo AMQP estão listados entre parênteses. 

| Nome da propriedade                         | Descrição                                                                                                                                                                                                                                                                                                                                                                                                                               |
|---------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  [`ContentType`](/dotnet/api/microsoft.azure.servicebus.message.contenttype) (Content-Type)           | Descreve opcionalmente o payload da mensagem com um descritor seguindo o formato de RFC2045, Seção 5; por exemplo, `application/json`.                                                                                                                                                                                                                                                                                             |
|  [`CorrelationId`](/dotnet/api/microsoft.azure.servicebus.message.correlationid#Microsoft_Azure_ServiceBus_Message_CorrelationId) (ID de correlação)       | Permite que um aplicativo especifique um contexto para a mensagem para fins de correlação; por exemplo, refletindo o **MessageId** de uma mensagem que está sendo respondida.                                                                                                                                                                                                                                                                  |
| [`DeadLetterSource`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deadlettersource)                      | Definido apenas em mensagens que tenham sido devolvidas e posteriores automaticamente da fila de mensagens mortas para outra entidade. Indica a entidade na qual a mensagem foi morta. Esta propriedade é somente para leitura.                                                                                                                                                                                                                                  |
| [`DeliveryCount`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount)                         | <p>Número de entregas que foram tentadas para essa mensagem. A contagem é incrementada quando um bloqueio de mensagem expira ou quando a mensagem é explicitamente abandonada pelo destinatário. Esta propriedade é somente para leitura.</p> <p>A contagem de entrega não é incrementada quando a conexão AMQP subjacente é fechada.</p>                                                                                                                                                                                                                                                 |
| [`EnqueuedSequenceNumber`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedsequencenumber)                | Para mensagens que foram encaminhadas automaticamente, essa propriedade reflete o número de sequência que havia sido atribuído primeiro à mensagem em seu ponto original de envio. Esta propriedade é somente para leitura.                                                                                                                                                                                                                                                                |
| [`EnqueuedTimeUtc`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedtimeutc)                       | O instante do UTC no qual a mensagem foi aceita e armazenada na entidade. Esse valor pode ser usado como um indicador de tempo de chegada autoritativo e neutro quando o receptor não quiser confiar no relógio do remetente. Esta propriedade é somente para leitura.                                                                                                                                                                                                   |
|  [`ExpiresAtUtc`](/dotnet/api/microsoft.azure.servicebus.message.expiresatutc) (absoluta – tempo de expiração) | O instante de UTC em que a mensagem é marcada para remoção e não está mais disponível para recuperação da entidade devido à expiração. A expiração é controlada pela propriedade **TimeToLive** e essa propriedade é computada em EnqueuedTimeUtc+TimeToLive. Esta propriedade é somente para leitura.                                                                                                                                                                           |
| [`ForcePersistence`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence)                      | Para filas ou tópicos que têm o [`EnableExpress`](/dotnet/api/microsoft.servicebus.messaging.queuedescription.enableexpress) sinalizador definido, essa propriedade pode ser definida para indicar que a mensagem deve ser persistida no disco antes de ser confirmada. Esse comportamento é o comportamento padrão para todas as entidades não expressas.                                                                                                                                                                                                         |
| [`Label`](/dotnet/api/microsoft.azure.servicebus.message.label) subjetiva                       | Essa propriedade permite que o aplicativo indique a finalidade da mensagem para o destinatário de maneira padronizada, semelhante a uma linha do assunto de email.                                                                                                                                                                                                                                                                                  |
| [`LockedUntilUtc`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.lockeduntilutc)                        | Para mensagens recuperadas com um bloqueio (modo de recebimento de bloqueio de pico, não previamente liquidadas) esta propriedade reflete o instante do UTC até que a mensagem seja mantida bloqueada na fila/assinatura. Quando o bloqueio expirar, o [DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount) será incrementado e a mensagem estará disponível novamente para recuperação. Esta propriedade é somente para leitura.                                                                                                                         |
| [`LockToken`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.locktoken)                             | O token de bloqueio é uma referência para o bloqueio que está sendo mantido pelo agente no modo de recebimento de *bloqueio de pico*. O token pode ser usado para fixar o bloqueio permanentemente por meio da API de [adiamento](message-deferral.md) e, com isso, tirar a mensagem fora do fluxo do estado de entrega regular. Esta propriedade é somente para leitura.                                                                                                                                                               |
| [`MessageId`](/dotnet/api/microsoft.azure.servicebus.message.messageid) (ID da mensagem)                | O identificador da mensagem é um valor definido pelo aplicativo que identifica exclusivamente a mensagem e seu payload. O identificador é uma cadeia de caracteres de forma livre e pode refletir um GUID ou um identificador derivado do contexto do aplicativo. Se habilitado, o recurso [detecção de duplicidades](duplicate-detection.md) identifica e remove a segunda e os envios adicionais de mensagens com o mesmo **MessageId**.                                                                |
| [`PartitionKey`](/dotnet/api/microsoft.azure.servicebus.message.partitionkey)                          | Para [entidades particionadas](service-bus-partitioning.md), definir esse valor permite a atribuição de mensagens relacionadas à mesma partição interna para que a ordem de sequência de envio esteja registrada corretamente. A partição é escolhida por uma função de hash sobre esse valor e não pode ser escolhida diretamente. Para entidades com reconhecimento de sessão, a propriedade **SessionId** substitui esse valor.                                                                                                       |
| [`ReplyTo`](/dotnet/api/microsoft.azure.servicebus.message.replyto) (responder a)                    | Esse valor opcional e definido pelo aplicativo é uma maneira padrão de expressar um caminho de resposta para o receptor da mensagem. Quando um remetente espera uma resposta, ele define o valor como o caminho absoluto ou relativo da fila ou do tópico para o qual ele espera que a resposta seja enviada.                                                                                                                                           |
| [`ReplyToSessionId`](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid) (reply-to-Group-ID)  | Esse valor aumenta a informação **ReplyTo** e especifica qual **SessionId** deve ser definido para a resposta quando enviada para a entidade de resposta.                                                                                                                                                                                                                                                                            |
| [`ScheduledEnqueueTimeUtc`](/dotnet/api/microsoft.azure.servicebus.message.scheduledenqueuetimeutc)               | Para mensagens disponibilizadas apenas para recuperação após um atraso, essa propriedade define o instante do UTC no qual a mensagem será logicamente enfileirada, sequenciada e, portanto, disponibilizada para recuperação.                                                                                                                                                                                                                 |
| [`SequenceNumber`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.sequencenumber)                        | O número de sequência é um inteiro de 64 bits atribuído a uma mensagem conforme ela é aceita e armazenada pelo agente e por funções como seu identificador verdadeiro. Para entidades particionadas, os 16 bits de nível mais alto refletem o identificador da partição. Os números de sequência aumentam de forma monotônica e não têm intervalo. Eles passam para 0 quando o intervalo de 48 a 64 bits é esgotado. Esta propriedade é somente para leitura.                                                                |
| [`SessionId`](/dotnet/api/microsoft.azure.servicebus.message.sessionid) (ID do grupo)                  | Para entidades com reconhecimento de sessão, esse valor definido pelo aplicativo especifica a afiliação de sessão da mensagem. As mensagens com o mesmo identificador de sessão estão sujeitas ao bloqueio de resumo e permitem a demultiplexação e o processamento na ordem exata. Para entidades que não estejam cientes de sessão, esse valor é ignorado.                                                                                                                                     |
| [`Size`](/dotnet/api/microsoft.azure.servicebus.message.size)                                  | Reflete o tamanho armazenado da mensagem no log do agente como uma contagem de bytes, uma vez que ele contribui com a cota de armazenamento. Esta propriedade é somente para leitura.                                                                                                                                                                                                                                                                                                       |
| [`State`](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.state)                                 | Indica o estado da mensagem no log. Essa propriedade só é relevante durante a pesquisa de mensagens (“pico”), para determinar se a mensagem está “ativa” e disponível para recuperação assim que ela atingir o topo da fila, se ela é adiada ou se está esperando para ser agendada. Esta propriedade é somente para leitura.                                                                                                                                           |
| [`TimeToLive`](/dotnet/api/microsoft.azure.servicebus.message.timetolive)                            | Esse valor é a duração relativa após a qual a mensagem expira, a partir do momento em que a mensagem foi aceita e armazenada pelo agente, conforme capturada em **EnqueueTimeUtc**. Quando não definido explicitamente, o valor assumido será o **DefaultTimeToLive** para a respectiva fila ou tópico. Um valor **TimeToLive** de nível de mensagem não pode ser maior que a configuração **DefaultTimeToLive** da entidade. Se ele for maior, é ajustado silenciosamente. |
| [To](/dotnet/api/microsoft.azure.servicebus.message.to) (to)                               | Essa propriedade é reservada para uso futuro em cenários de roteamento e é atualmente ignorada pelo próprio agente. Os aplicativos podem usar esse valor em cenários de encadeamento de encaminhamento automático controlado por regras para indicar o destino lógico pretendido da mensagem.                                                                                                                                                                                   |
| [`ViaPartitionKey`](/dotnet/api/microsoft.azure.servicebus.message.viapartitionkey)                       | Se uma mensagem é enviada por meio de uma fila de transferência no escopo de uma transação, esse valor seleciona a partição da fila de transferência.                                                                                                                                                                                                                                                                                                                 |

O modelo de mensagem abstrata permite que uma mensagem seja postada em uma fila via HTTPS e possa ser recuperada via AMQP. Em qualquer caso, a mensagem parece normal no contexto do respectivo protocolo. As propriedades do agente são convertidas conforme necessário e as propriedades do usuário são mapeadas para o local mais adequado no respectivo modelo de mensagem de protocolo. Em HTTP, as propriedades do usuário são mapeadas diretamente para os cabeçalhos HTTP e deles; em AMQP, elas são mapeadas para o mapa **propriedades do aplicativo** e dele.

## <a name="message-routing-and-correlation"></a>Roteamento e correlação de mensagens

Um subconjunto das propriedades do agente descritas anteriormente, especificamente [To](/dotnet/api/microsoft.azure.servicebus.message.to), [ReplyTo](/dotnet/api/microsoft.azure.servicebus.message.replyto), [ReplyToSessionId](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid), [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid), [CorrelationId](/dotnet/api/microsoft.azure.servicebus.message.correlationid) e [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), são usadas para ajudar os aplicativos a rotear mensagens para destinos específicos. Para ilustrar esse recurso, considere alguns padrões:

- **Solicitação/resposta simples**: um editor envia uma mensagem em uma fila e espera uma resposta do consumidor da mensagem. Para receber a resposta, o editor tem uma fila para a qual ele espera que as respostas sejam entregues. O endereço dessa fila é expresso na propriedade **ReplyTo** da mensagem de saída. Quando o consumidor responde, ele copia o **MessageId** da mensagem tratada para a propriedade **CorrelationId** da mensagem de resposta e entrega a mensagem ao destino indicado pela propriedade **ReplyTo**. Uma mensagem pode render várias respostas, dependendo do contexto do aplicativo.
- **Solicitação/resposta multicast**: como uma variação do padrão anterior, um editor envia a mensagem em um tópico e vários assinantes se tornam elegíveis para consumi-la. Cada um dos assinantes pode responder da maneira descrita anteriormente. Esse padrão é usado em cenários de descoberta ou de chamada de rolagem, e o participante normalmente identifica-se com uma propriedade de usuário ou dentro do payload. Se **ReplyTo** aponta para um tópico, esse conjunto de respostas de descoberta pode ser distribuído para um público-alvo.
- **Multiplexação**: este recurso de sessão permite a multiplexação de fluxos de mensagens relacionadas por meio de uma única fila ou da assinatura de modo que cada sessão (ou grupo) de mensagens relacionadas, identificadas pelos valores **SessionId** correspondentes, seja roteada para um destinatário específico enquanto o receptor mantém a sessão bloqueada. Leia mais sobre os detalhes das sessões [aqui](message-sessions.md).
- **Solicitação/resposta multiplexada**: este recurso de sessão permite respostas multiplexadas, possibilitando que vários editores compartilhem uma fila de resposta. Ao definir **ReplyToSessionId**, editor pode instruir os consumidores a copiar esse valor para a propriedade **SessionId** da mensagem de resposta. A fila ou o tópico de publicação não precisa ter reconhecimento de sessão. Assim que a mensagem é enviada, o editor pode aguardar especificamente uma sessão com o **SessionId** fornecido ser materializada na fila aceitando condicionalmente um receptor de sessão. 

O roteamento dentro de um namespace do barramento de serviço pode ser percebido usando regras de assinatura de tópico e encadeamento de encaminhamento automático. O roteamento entre namespaces pode ser obtido [usando o Azure LogicApps](https://azure.microsoft.com/services/logic-apps/). Conforme indicado na lista anterior, a propriedade **To** é reservada para uso futuro e pode, eventualmente, ser interpretada pelo agente com um recurso especialmente habilitado. Os aplicativos que desejam implementar o roteamento devem fazer isso com base nas propriedades do usuário e não na propriedade **to** . no entanto, fazer isso agora não causará problemas de compatibilidade.

## <a name="payload-serialization"></a>Serialização de payload

Quando estiver em trânsito ou armazenado dentro do Barramento de Serviço, o payload é sempre um bloco opaco e binário. A propriedade [ContentType](/dotnet/api/microsoft.azure.servicebus.message.contenttype) permite que os aplicativos descrevam o payload com o formato sugerido para os valores de propriedade, sendo uma descrição de tipo de conteúdo MIME de acordo com a IETF RFC2045; por exemplo, `application/json;charset=utf-8`.

Diferentemente das variantes Java ou .NET Standard, a versão .NET Framework da API do Barramento de Serviço dá suporte à criação de instâncias **BrokeredMessage** passando objetos .NET arbitrários para o construtor. 

Ao usar o protocolo SBMP herdado, esses objetos são serializados com o serializador binário padrão ou com um serializador fornecido externamente. Ao usar o protocolo AMQP, o objeto é serializado em um objeto AMQP. O receptor pode recuperar esses objetos com o método [GetBody\<T>()](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.getbody#Microsoft_ServiceBus_Messaging_BrokeredMessage_GetBody__1), fornecendo o tipo esperado. Com o AMQP, os objetos são serializados em um grafo AMQP de `ArrayList` `IDictionary<string,object>` objetos e qualquer cliente AMQP pode decodificá-los. 

Embora essa mágica de serialização oculta seja conveniente, os aplicativos devem assumir o controle explícito da serialização do objeto e transformar os grafos dos seus objetos em fluxos antes de incluí-los em uma mensagem e fazer o contrário no lado do receptor. Isso produz resultados interoperáveis. Embora o AMQP tenha um poderoso modelo de codificação binária, ele está vinculado ao ecossistema do sistema de mensagens do AMQP e os clientes HTTP terão problemas para decodificar tais cargas. 

As variantes de .NET Standard e Java API só aceitam matrizes de bytes, o que significa que o aplicativo deve lidar com o controle de serialização do objeto. 

## <a name="next-steps"></a>Próximas etapas

Para saber mais sobre as mensagens do Barramento de Serviço, consulte os seguintes tópicos:

* [Filas, tópicos e assinaturas do Barramento de Serviço](service-bus-queues-topics-subscriptions.md)
* [Introdução às filas do Barramento de Serviço](service-bus-dotnet-get-started-with-queues.md)
* [Como usar tópicos e assinaturas do Barramento de Serviço](service-bus-dotnet-how-to-use-topics-subscriptions.md)
