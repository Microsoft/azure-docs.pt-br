---
title: Alta disponibilidade com vídeo dos serviços de mídia sob demanda
description: Este artigo é uma visão geral dos serviços do Azure que você pode usar para facilitar a alta disponibilidade para o aplicativo VOD.
services: media-services
documentationcenter: ''
author: IngridAtMicrosoft
manager: femila
editor: ''
ms.service: media-services
ms.subservice: ''
ms.workload: ''
ms.topic: conceptual
ms.custom: ''
ms.date: 08/31/2020
ms.author: inhenkel
ms.openlocfilehash: 2b0158c3b1bbee37fdb10c8fc0131be580ad6fc0
ms.sourcegitcommit: f0a3ee8ff77ee89f83b69bc30cb87caa80f1e724
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/26/2021
ms.locfileid: "105562606"
---
# <a name="high-availability-with-media-services-and-video-on-demand-vod"></a>Alta disponibilidade com os serviços de mídia e vídeo por demanda (VOD)

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

## <a name="high-availability-for-vod"></a>Alta disponibilidade para VOD

Há um padrão de design de alta disponibilidade chamado [Geodes](/azure/architecture/patterns/geodes) na documentação da arquitetura do Azure. Ele descreve como os recursos duplicados são implantados em regiões geográficas diferentes para fornecer escalabilidade e resiliência.  Você pode usar os serviços do Azure para criar uma arquitetura desse tipo para cobrir muitas considerações de design de alta disponibilidade, como redundância, monitoramento de integridade, balanceamento de carga e backup e recuperação de dados.  Uma dessas arquiteturas é descrita abaixo com detalhes sobre cada serviço usado na solução, bem como como os serviços individuais podem ser usados para criar uma arquitetura de alta disponibilidade para seu aplicativo VOD.

### <a name="sample"></a>Amostra

Há um exemplo disponível para você usar o para se familiarizar com a alta disponibilidade com os serviços de mídia e VOD (vídeo por demanda). Ele também apresenta mais detalhes sobre como os serviços são usados para um cenário VOD.  O exemplo não se destina a ser usado na produção em sua forma atual.  Examine atentamente o código de exemplo e o Leiame, particularmente a seção sobre os [modos de falha](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/HighAvailabilityEncodingStreaming) antes de integrá-lo a um aplicativo de produção.  Uma implementação de produção de alta disponibilidade para vídeo por demanda (VOD) também deve examinar cuidadosamente sua estratégia de CDN (rede de distribuição de conteúdo).  Confira o [código no GitHub](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/master/HighAvailabilityEncodingStreaming).

## <a name="overview-of-services"></a>Visão geral dos serviços

Os serviços usados nesta arquitetura de exemplo incluem:

| ícone | Nome | Descrição |
| :--: | ---- | ----------- |
|![Este é o ícone de conta dos serviços de mídia.](media/media-services-high-availability-encoding/azure-media-services.svg)| Conta dos serviços de mídia | **Descrição:**<br>Uma conta dos serviços de mídia é o ponto de partida para gerenciar, criptografar, codificar, analisar e transmitir conteúdo de mídia no Azure. Ele está associado a um recurso de conta de armazenamento do Azure. A conta e todo o armazenamento associado devem estar na mesma assinatura do Azure.<br><br>**VOD usar:**<br>Esses são os serviços que você usa para codificar e entregar seus ativos de áudio e vídeo.  Para alta disponibilidade, você deve configurar pelo menos duas contas de serviços de mídia, cada uma em uma região diferente. [Saiba mais sobre os serviços de mídia do Azure](media-services-overview.md). |
|![Este é o ícone da conta de armazenamento.](media/media-services-high-availability-encoding/storage-account.svg)| Conta de armazenamento | **Descrição:**<br>Uma conta de armazenamento do Azure contém todos os seus objetos de dados de armazenamento do Azure: BLOBs, arquivos, filas, tabelas e discos. Os dados podem ser acessados de qualquer lugar do mundo por HTTP ou HTTPS.<br><br>Cada conta dos serviços de mídia, em cada região, teria uma conta de armazenamento na mesma região.<br><br>**VOD usar:**<br>Você pode armazenar dados de entrada e saída para processamento e streaming de VOD. [Saiba mais sobre o armazenamento do Azure](../../storage/common/storage-introduction.md). |
|![Este é o ícone de fila de armazenamento do Azure.](media/media-services-high-availability-encoding/storage-account-queue.svg)| Fila de Armazenamento do Azure | **Descrição:**<br>O armazenamento de filas do Azure é um serviço para armazenamento de um grande número de mensagens que podem ser acessadas de qualquer lugar do mundo por meio de chamadas autenticadas usando HTTP ou HTTPS.<br><br>**VOD usar:**<br>As filas podem ser usadas para enviar e receber mensagens para coordenar atividades entre diferentes módulos. O exemplo usa uma fila de armazenamento do Azure, mas o Azure fornece outros tipos de filas, como o barramento de serviço e Service Fabric filas confiáveis que podem atender melhor às suas necessidades. [Saiba mais sobre a fila do Azure](../../storage/queues/storage-queues-introduction.md). |
|![Este é o ícone de Azure Cosmos DB.](media/media-services-high-availability-encoding/azure-cosmos-db.svg)| Azure Cosmos DB  | **Descrição:**<br>Azure Cosmos DB é o serviço de banco de dados multimodelo distribuído globalmente da Microsoft que dimensiona de forma independente a taxa de transferência e o armazenamento em qualquer número de regiões do Azure em todo o mundo.<br><br>**VOD usar:**<br>As tabelas podem ser usadas para armazenar registros de status de saída do trabalho e para acompanhar o estado de integridade de cada instância dos serviços de mídia. Você também pode rastrear/registrar o status de cada chamada para a API dos serviços de mídia. [Saiba mais sobre Azure Cosmos DB](../../cosmos-db/introduction.md).  |
|![Este é o ícone de identidade gerenciada.](media/media-services-high-availability-encoding/managed-identity.svg)| Identidade Gerenciada | **Descrição:**<br>A identidade gerenciada é um recurso do Azure AD que fornece uma identidade gerenciada automaticamente no Azure AD. Ele pode ser usado para autenticar em qualquer serviço que dê suporte à autenticação do Azure AD, incluindo Key Vault, sem armazenar credenciais no código.<br><br>**VOD usar:**<br>Azure Functions pode usar a identidade gerenciada para se autenticar em instâncias dos serviços de mídia para se conectar ao Key Vault. [Saiba mais sobre a identidade gerenciada](../../active-directory/managed-identities-azure-resources/overview.md). |
|![Este é o ícone de Key Vault.](media/media-services-high-availability-encoding/key-vault.svg)| Key Vault | **Descrição:**<br>Azure Key Vault pode ser usado para armazenar e controlar de forma segura o acesso a tokens, senhas, certificados, chaves de API e outros segredos. Ele também pode ser usado como uma solução de gerenciamento de chaves. O Azure Key Vault torna fácil criar e controlar as chaves de criptografia usadas para criptografar seus dados. Ele pode facilmente provisionar, gerenciar e implantar certificados de TLS/SSL (segurança de camada de transporte/protocolo SSL) públicos e privados para uso com o Azure e recursos internos conectados. Segredos e chaves podem ser protegidos pelos HSMs validados pelo software ou pelo FIPS 140-2 nível 2.<br><br>**VOD usar:**<br>Key Vault pode ser usado para configurar políticas de acesso para a entidade de serviço para seu aplicativo.  Ele pode ser usado para armazenar a cadeia de conexão para contas de armazenamento. Usamos Key Vault para armazenar cadeias de conexão para contas de armazenamento e Cosmos DB. Você também pode usar Key Vault para armazenar a configuração geral do cluster. Para cada instância do serviço de mídia, você pode armazenar a ID da assinatura, o nome do grupo de recursos e o nome da conta. Para obter mais detalhes, consulte como ele é usado no exemplo. [Saiba mais sobre Key Vault](../../key-vault/general/overview.md). |
|![Este é o ícone de Azure Functions.](media/media-services-high-availability-encoding/function-app.svg)| Funções do Azure | **Descrição:**<br>Execute pequenas partes de código (chamadas de "funções") sem se preocupar com a infraestrutura do aplicativo com Azure Functions. [Saiba mais sobre Azure Functions](../../azure-functions/functions-overview.md).<br><br>**VOD usar:**<br>Azure Functions pode ser usado para armazenar o host dos módulos do seu aplicativo VOD.  Os módulos para um aplicativo VOD podem incluir:<br><br>**Módulo de agendamento de trabalho**<br>O módulo de agendamento de trabalho seria enviar novos trabalhos para um cluster dos serviços de mídia (duas ou mais instâncias em regiões diferentes). Ele acompanharia o status de integridade de cada instância dos serviços de mídia e enviaria um novo trabalho para a próxima instância íntegra.<br><br>**Módulo de status do trabalho**<br>O módulo status do trabalho estaria ouvindo eventos de status de saída do trabalho provenientes do serviço de grade de eventos do Azure. Ele armazenaria eventos no repositório de eventos para minimizar o número de chamadas para APIs de serviços de mídia pelo restante dos módulos.<br><br>**Módulo de integridade da instância**<br>Esse módulo acompanharia os trabalhos enviados e determinaria o status de integridade de cada instância dos serviços de mídia. Ele acompanharia os trabalhos concluídos, trabalhos com falha e trabalhos que nunca concluíram.<br><br>**Módulo de provisionamento**<br>Este módulo provisiona ativos processados. Ele copiaria os dados do ativo para todas as instâncias dos serviços de mídia e configuraria o serviço de porta frontal do Azure para garantir que os ativos pudessem ser transmitidos mesmo se algumas instâncias dos serviços de mídia não esestivessessem disponíveis. Ele também configuraria localizadores de streaming.<br><br>**Módulo de verificação de trabalho**<br>Esse módulo acompanharia cada trabalho enviado, reenviaria os trabalhos com falha e executaria a limpeza dos dados de trabalho quando um trabalho for concluído com êxito.  |
|![Este é o ícone do serviço de aplicativo.](media/media-services-high-availability-encoding/application-service.svg)| Serviço de aplicativo (e plano)  | **Descrição:**<br>O Serviço de Aplicativo do Azure é um serviço com base em HTTP para hospedagem de aplicativos Web, APIs REST e back-ends móveis. Ele dá suporte a .NET, .NET Core, Java, Ruby, Node.js, PHP ou Python. Os aplicativos são executados e dimensionados em ambientes baseados em Windows e Linux.<br><br>**VOD usar:**<br>Cada módulo seria hospedado por um serviço de aplicativo. [Saiba mais sobre o serviço de aplicativo](../../app-service/overview.md). |
|![Este é o ícone de porta frontal do Azure.](media/media-services-high-availability-encoding/azure-front-door.svg)| Porta da frente do Azure | **Descrição:**<br>A porta frontal do Azure é usada para definir, gerenciar e monitorar o roteamento global do tráfego da Web, otimizando para melhor desempenho e failover global rápido para alta disponibilidade.<br><br>**VOD usar:**<br>A porta frontal do Azure pode ser usada para rotear o tráfego para pontos de extremidade de streaming. [Saiba mais sobre a porta frontal do Azure](../../frontdoor/front-door-overview.md).  |
|![Este é o ícone da grade de eventos do Azure.](media/media-services-high-availability-encoding/event-grid-subscription.svg)| Grade de Eventos do Azure | **Descrição:**<br>Criado para arquiteturas baseadas em eventos, a grade de eventos tem suporte interno para eventos provenientes de serviços do Azure, como BLOBs de armazenamento e grupos de recursos. Ele também tem suporte para eventos de tópico personalizado. Os filtros podem ser usados para rotear eventos específicos para diferentes pontos de extremidade, multicast para vários pontos de extremidade e para garantir que os eventos sejam entregues de forma confiável. Ele maximiza a disponibilidade por meio da disseminação nativa entre vários domínios de falha em cada região e entre zonas de disponibilidade.<br><br>**VOD usar:**<br>A grade de eventos pode ser usada para acompanhar todos os eventos do aplicativo e armazená-los para manter o status do trabalho. [Saiba mais sobre a grade de eventos do Azure](../../event-grid/overview.md). |
|![Este é o ícone de Application Insights.](media/media-services-high-availability-encoding/application-insights.svg)| Application Insights | **Descrição:** <br>O Application Insights, um recurso do Azure Monitor, é um serviço de APM (gerenciamento de desempenho de aplicativos) extensível para desenvolvedores e profissionais de DevOps. Ele é usado para monitorar aplicativos dinâmicos. Ele detecta anomalias de desempenho e inclui ferramentas de análise para diagnosticar problemas e entender o que os usuários fazem com um aplicativo. Ele foi projetado para ajudar você a aprimorar continuamente o desempenho e a usabilidade do seu aplicativo.<br><br>**VOD usar:**<br>Todos os logs podem ser enviados para Application Insights. Seria possível ver qual instância processou cada trabalho pesquisando mensagens de trabalho criadas com êxito. Ele pode conter todos os metadados de trabalho enviados, incluindo o identificador exclusivo e as informações de nome de instância. [Saiba mais sobre Application insights](../../azure-monitor/app/app-insights-overview.md). |
## <a name="architecture"></a>Arquitetura

Este diagrama de alto nível mostra a arquitetura do exemplo fornecido para ajudá-lo a começar a usar a alta disponibilidade e os serviços de mídia.

[![Diagrama ](media/media-services-high-availability-encoding/high-availability-architecture.svg) de arquitetura de alto nível do VOD (vídeo por demanda)](media/media-services-high-availability-encoding/high-availability-architecture.svg#lightbox)

## <a name="best-practices"></a>Práticas recomendadas

### <a name="regions"></a>Regiões

* [Crie](./create-account-howto.md) duas (ou mais) contas dos serviços de mídia do Azure. As duas contas precisam estar em regiões diferentes. Para obter mais informações, consulte [regiões nas quais o serviço dos serviços de mídia do Azure está implantado](https://azure.microsoft.com/global-infrastructure/services/?products=media-services).
* Carregue sua mídia na mesma região da qual você está planejando para enviar o trabalho. Para obter mais informações sobre como iniciar a codificação, consulte [criar uma entrada de trabalho de uma URL https](./job-input-from-http-how-to.md) ou [criar uma entrada de trabalho de um arquivo local](./job-input-from-local-file-how-to.md).
* Se você precisar reenviar o [trabalho](./transforms-jobs-concept.md) para outra região, poderá usar `JobInputHttp` ou usar `Copy-Blob` o para copiar os dados do contêiner de ativos de origem para um contêiner de ativos na região alternativa.

### <a name="monitoring"></a>Monitoramento

* Assinar `JobStateChange` mensagens em cada conta por meio da grade de eventos do Azure.
    * [Registrar-se para eventos](./reacting-to-media-services-events.md) por meio do portal do Azure ou da CLI (você também pode fazer isso com o SDK de gerenciamento da grade de eventos)
    * Use o [SDK do Microsoft. Azure. EventGrid](https://www.nuget.org/packages/Microsoft.Azure.EventGrid/) (que dá suporte a eventos dos serviços de mídia nativamente).
    * Você também pode consumir eventos de grade de eventos via Azure Functions.

    Para mais informações:

    * Consulte o [exemplo de análise de áudio](./transforms-jobs-concept.md) que mostra como monitorar um trabalho com a grade de eventos do Azure, incluindo a adição de um fallback, caso as mensagens da grade de eventos do Azure sejam atrasadas por algum motivo.
    * Dê uma olhada nos [esquemas da grade de eventos do Azure para eventos dos serviços de mídia](./media-services-event-schemas.md).

* Quando você cria um [trabalho](./transforms-jobs-concept.md):
    * Selecione aleatoriamente uma conta na lista de contas atualmente usadas (essa lista normalmente conterá as duas contas, mas se forem detectadas problemas, ela poderá conter apenas uma conta). Se a lista estiver vazia, gere um alerta para que um operador possa investigar.
    * Crie um registro para acompanhar cada trabalho do em andamento e a região/conta usada.
* Quando o `JobStateChange` manipulador recebe uma notificação de que um trabalho atingiu o estado agendado, registre a hora em que ele entra no estado agendado e a região/conta usada.
* Quando o `JobStateChange` manipulador recebe uma notificação de que um trabalho atingiu o estado de processamento, marque o registro para o trabalho como processamento e registre a hora em que ele entra no estado de processamento.
* Quando o `JobStateChange` manipulador recebe uma notificação de que um trabalho atingiu um estado final (concluído/com erro/cancelado), marque o registro para o trabalho adequadamente.
* Ter um processo separado que examina periodicamente os registros dos trabalhos
    * Se você tiver trabalhos no estado agendado que não são avançados para o estado de processamento em um período razoável de tempo para uma determinada região, remova essa região da sua lista de contas atualmente usadas. Dependendo dos seus requisitos de negócios, você pode optar por cancelar esses trabalhos imediatamente e reenviá-los para a outra região. Ou você pode dar mais tempo para passar para o próximo estado.
    * Se uma região tiver sido removida da lista de contas, monitore-a para recuperação antes de adicioná-la de volta à lista. A integridade regional pode ser monitorada por meio dos trabalhos existentes na região (se eles não foram cancelados e reenviados), adicionando a conta de volta à lista após um período de tempo e por operadores monitorando as comunicações do Azure sobre interrupções que podem estar afetando os serviços de mídia do Azure.

## <a name="next-steps"></a>Próximas etapas

* Confira [exemplos de código](/samples/browse/?products=azure-media-services)